#!/usr/bin/php
<?php

/**
 * mwci
 * 
 * The interactive Maxwell compiler and interpreter.
 */

require_once __DIR__.'/../lib/autoload.php';
error_reporting(E_ALL ^ E_NOTICE);

$mwci = new mwci;


foreach (array_slice($argv, 1) as $path) {
	$mwci->import($path);
}


while (true)
{
	$input = readline(sprintf("mwci> "));
	if (strlen($input) == 0) continue;
	
	if ($input[0] == ':') {
		$mwci->processCommand(rtrim(substr($input, 1)));
	} else {
		$mwci->processInput($input);
	}
}


class mwci
{
	public $root;
	
	public function __construct()
	{
	}
	
	public function processCommand($command)
	{
		$args    = explode(' ', $command);
		$command = array_shift($args);
		switch ($command) {
			case 'quit':
			case 'q': exit; break;
			
			case 'scope': $this->dumpScope(); break;
			
			case 'import': {
				if (count($args) != 1) {
					echo "'import' requires \033[31mone file path\033[0m as argument.\n";
					return;
				}
				$this->import($args[0]);
			} break;
			
			default: {
				echo "\033[31mUnknown command\033[0m '$command'. Type ':help' for an overview of commands.\n";
			} break;
		}
	}
	
	public function processInput($input)
	{
		$file = new SourceFile;
		$file->path = 'interactive';
		$file->content = $input;

		$this->processFile($file);
	}
	
	public function import($path)
	{
		$file = new SourceFile;
		$file->path = $path;
		if (!file_exists($file->path)) {
			$i = new Issue(
				'error',
				"Source file '{$file->path}' does not exist."
			);
			echo "$i\n";
			return;
		}
		$file->load();
		$this->processFile($file);
	}
	
	public function processFile(SourceFile $file)
	{
		global $issues;
		$issues = new IssueList;
		
		$lexer = new Lexer;
		$lexer->file = $file;
		$lexer->run();
		if ($issues->isFatal()) goto issues;

		$parser = new Parser;
		$parser->tokens = $lexer->tokens;
		$parser->issues = $issues;
		$parser->run();
		if ($issues->isFatal()) goto issues;
		
		$analyzer = new Analyzer;
		$analyzer->root   = $this->root;
		$analyzer->issues = $issues;
		$analyzer->nodes  = $parser->nodes;
		$analyzer->finalize = false;
		$analyzer->restrictRootLevel = false;
		$analyzer->run();
		$this->root = $analyzer->root;
		if ($issues->isFatal()) goto issues;
		
		issues:
		$issues->dump();
	}
	
	private function dumpScope()
	{
		$scope = $this->root;
		if ($scope) $scope = $scope->scope;
		if (!$scope) {
			echo "No scope has been initialized yet. Start typing!\n";
			return;
		}
		
		foreach ($scope->funcs as $func) echo "\033[1mfunc\033[0m \033[34m{$func->name()}\033[0m {$func->argDetails()}\n";
		foreach ($scope->types as $type) {
			$str = "\033[1mtype\033[0m \033[34m{$type->name()}\033[0m";
			if (!$type->isSpecific()) $str .= " \033[35mgeneric\033[0m";
			$str .= "\n";
			echo $str;
		}
		
		foreach ($scope->vars as $variable) {
			$str = "\033[1mvar\033[0m";
			if (!$variable->type() instanceof LET\GenericType) $str .= " {$variable->type()->details()}";
			$str .= " \033[34m{$variable->name()}\033[0m\n";
			echo $str;
		}
	}
}
