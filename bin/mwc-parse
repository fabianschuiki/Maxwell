#!/usr/bin/php
<?php
require_once __DIR__."/../source/autoload.php";
error_reporting(E_ALL);

if (count($argv) < 3) {
	echo "usage: mwc-parse OUTPUT_DIR INPUT_FILE\n";
	exit;
}

$output_dir = $argv[1];
$input_file = $argv[2];

if (!file_exists($output_dir))
	mkdir($output_dir);

$issues = new IssueList;
$issues->push();

$manager = new Store\Manager($output_dir);
$manager->push();
$tokenStore = $manager->getTokenStore();

$file = $manager->getSourceFileAtPath($input_file);

$lexer = new Lexer\Lexer($file);
$lexer->run();
$issues->reportAndExitIfFatal();

//Serialize the tokens.
$root = Store\TokenStore::serializeTokens($lexer->getTokens());
$xml = new Coder\XMLCoder;
$xml->encodeToFile($root, $output_dir."/tokens.xml");

$parser = new Parser\Parser($lexer->getTokens());
$parser->run();
$issues->reportAndExitIfFatal();

$issues->pop();
$issues->report();

$manager->pop();